{% extends "users/basic.html" %}
{% block content %}

<div class="container py-5">
  <h1 class="text-center mb-5">Movies</h1>

  <!-- FILTER FORM -->
  <form method="GET" action="{% url 'movies:movie_list' %}" class="mb-5">
    <div class="row g-3 align-items-end">

      <!-- SEARCH -->
      <div class="col-md-6">
        <label class="form-label">Search</label>
        <input
          type="text"
          name="search"
          class="form-control"
          placeholder="Search movies by name"
          value="{{ request.GET.search|default_if_none:'' }}"
        />
      </div>

      <!-- LANGUAGE -->
      <div class="col-md-3">
        <label class="form-label">Language</label>
        <select name="language" class="form-control">
          <option value="">All Languages</option>
          {% for lang in languages %}
            <option value="{{ lang.name }}"
              {% if request.GET.language == lang.name %}selected{% endif %}
            >
              {{ lang.name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- SUBMIT -->
      <div class="col-md-3">
        <button type="submit" class="btn btn-primary w-100">
          Apply Filters
        </button>
      </div>
    </div>

    <!-- GENRES -->
    <div class="row mt-4">
      <div class="col-12">
        <label class="form-label d-block">Genres</label>
        {% for genre in genres %}
          <div class="form-check form-check-inline">
            <input
              class="form-check-input"
              type="checkbox"
              name="genre"
              value="{{ genre.name }}"
              {% if genre.name in selected_genres %}checked{% endif %}
            >
            <label class="form-check-label">
              {{ genre.name }}
            </label>
          </div>
        {% endfor %}
      </div>
    </div>
  </form>

  <!-- MOVIE LIST -->
  <div class="row">
    {% for movie in movies %}
      <div class="col-md-4 mb-4">
        <div class="card h-100 shadow-sm">
          <img
            src="{{ movie.image.url }}"
            class="card-img-top"
            alt="{{ movie.name }}"
            style="height: 300px; object-fit: cover"
          />

          <div class="card-body">
            <h5 class="card-title">{{ movie.name }}</h5>
            <p class="card-text">
              <i class="fas fa-star text-warning"></i> {{ movie.rating }}
            </p>
            <p class="card-text">
              <small class="text-muted">
                <i class="fas fa-users"></i> Cast: {{ movie.cast }}
              </small>
            </p>
          </div>

          <div class="card-footer bg-white border-top-0">
            <a
              href="{% url 'movies:theatre_list' movie.id %}"
              class="btn btn-outline-primary w-100 mb-2"
            >
              View Theatres
            </a>

            {% if movie.trailer_url %}
            <a
              href="#"
              class="btn btn-outline-danger w-100"
              data-bs-toggle="modal"
              data-bs-target="#trailerModal{{ movie.id }}"
            >
              ▶ Watch Trailer
            </a>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- TRAILER MODAL -->
      {% if movie.trailer_url %}
      <div
        class="modal fade"
        id="trailerModal{{ movie.id }}"
        tabindex="-1"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">

            <div class="modal-header">
              <h5 class="modal-title">{{ movie.name }} – Trailer</h5>
              <button
                type="button"
                class="btn-close"
                data-bs-dismiss="modal"
                aria-label="Close">
              </button>
            </div>

            <div class="modal-body p-0">
              <div class="ratio ratio-16x9">
                <iframe
                  src="{{ movie.trailer_url }}"
                  width="100%"
                  height="400"
                  frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allowfullscreen>
                </iframe>
              </div>
            </div>

          </div>
        </div>
      </div>
      {% endif %}

    {% empty %}
      <div class="col-12 text-center">
        <p class="lead">No movies found.</p>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"
/>

<style>
  .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15) !important;
  }
</style>

<!-- STOP VIDEO ON MODAL CLOSE -->
<script>
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('hidden.bs.modal', function () {
      const iframe = modal.querySelector('iframe');
      if (iframe) {
        iframe.src = iframe.src;
      }
    });
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>


{% endblock %}
